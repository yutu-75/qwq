"use strict";(globalThis.webpackChunksuperset=globalThis.webpackChunksuperset||[]).push([[17982],{73995:(e,t,a)=>{a.d(t,{Mh:()=>_,ZP:()=>w});var n=a(187185),l=a.n(n),s=a(667294),o=a(751995),r=a(455867),i=a(431069),d=a(49937),c=a(737921),u=a(49238),h=a(940277),m=a(414114),b=a(442582),p=a(748086),f=a(970553),v=a(211965);const g=o.iK.div`
  display: flex;
  flex-direction: row;
  align-items: center;
  margin-left: ${({theme:e})=>e.gridUnit-2}px;

  .backend {
    overflow: visible;
  }

  .name {
    overflow: hidden;
    text-overflow: ellipsis;
  }
`,S=o.iK.div`
  ${({theme:e})=>`\n  display: flex;\n  flex-direction: row;\n  align-items: center;\n\n  & + & {\n    margin-top: ${4*e.gridUnit}px;\n  }\n\n  .select {\n    width: calc(100% - ${e.gridUnit+20}px);\n    flex: 1;\n  }\n\n  .refresh {\n    display: flex;\n    align-items: center;\n    width: 20px;\n    margin-left: ${e.gridUnit}px;\n    margin-top: ${5.5*e.gridUnit}px;\n\n    span[role="button"]{\n      font-size: ${4.25*e.gridUnit}px;\n    }\n  }\n`}
`,Z=({backend:e,databaseName:t})=>(0,v.tZ)(g,null,(0,v.tZ)(c.Z,{className:"backend"},e),(0,v.tZ)("span",{className:"name",title:t},t)),_=({renderSelect:e,refreshBtn:t})=>(0,v.tZ)(S,{className:"section"},(0,v.tZ)("span",{className:"select"},e),(0,v.tZ)("span",{className:"refresh"},t)),y=[];function w({db:e,formMode:t=!1,emptyState:a,getDbList:n,handleError:o,isDatabaseSelectEnabled:c=!0,onDbChange:g,onEmptyResults:S,onSchemaChange:w,onSchemasLoad:x,readOnly:$=!1,schema:C,sqlLabMode:E=!1}){const[N,k]=(0,s.useState)(),[I,L]=(0,s.useState)(C?{label:C,value:C,title:C}:void 0),[j,M]=(0,s.useState)(),[O,D]=(0,s.useState)([]),{addSuccessToast:R}=(0,m.e1)(),[T,U]=(0,s.useState)(""),J=(e,t)=>{const a=e.indexOf(t),n=e.substr(0,a),l=e.substr(a+t.length);return a>-1?(0,v.tZ)("span",{style:{color:"#000"}},n,(0,v.tZ)("span",{style:{color:"#f50"}},t),l):(0,v.tZ)("span",{style:{color:"#000"}},e)},z=(e=[],t)=>{let a=[];return e.map((e=>{var n;const l=z(e.children,t);return-1!==(null==e||null==(n=e.name)?void 0:n.indexOf(t))?(l&&l.length&&(e.children=l),a.push({...e,title:J(e.name,t)})):l&&l.length&&(e.children=l,a.push({...e,title:J(e.name,t)})),!1})),a},F=(0,s.useMemo)((()=>z(O,T)),[T,O]);function P(e){L(e),w&&w(null==e?void 0:e.value)}(0,s.useEffect)((()=>{k((t=>{const a=e&&JSON.parse(JSON.stringify(e));return e&&(a.database_name=((null==a?void 0:a.database_name)||"").replace(/_\d{13}$/,"")),(null==t?void 0:t.id)!==(null==a?void 0:a.id)?a?{label:(0,v.tZ)(Z,{backend:a.backend,databaseName:a.database_name}),value:a.id,...a}:void 0:t})),M(null==e?void 0:e.id)}),[e]);const{data:q,isFetching:B,isFetched:A,refetch:X}=(0,b.Xx)({dbId:null==N?void 0:N.value,onSuccess:e=>{null==x||x(e),1===e.length?P(e[0]):e.find((e=>C===e.value))||P(void 0),A&&R("List refreshed")},onError:()=>o((0,r.t)("There was an error loading the schemas"))}),K=q||y,Q=(e,t,a)=>{M(e),U(""),g&&g({id:e}),w&&w(void 0)};return(0,s.useEffect)((()=>{i.Z.get({endpoint:"/api/v2/datasource/group/"}).then((e=>{if(200==e.json.meta.code||201==e.json.meta.code){const t=e.json.meta.data||[],a=[],n=e=>e.length?e.map((e=>{var t,s,o;const r={value:`${e.group_id}&&${e.name}`,name:e.name,selectable:!1},i=sessionStorage.getItem("chart_basicInfo"),d=((null==(t=JSON.parse(i||"{}"))?void 0:t.key_name)||"").split("&&")[6]||"7",c={0:"database",1:"database"};let u=e.datasources.filter((e=>!c[d]||e.d_type===c[d])).map((e=>a.includes(e.database_id)?null:(a.push(e.database_id),{value:e.database_id,name:e.name}))).filter((e=>e));if(u=l()(u,((e,t)=>e.value===t.value)),u.length&&(r.children=u),e.children&&e.children.length){const t=n(e.children);r.children?r.children=[...t,...r.children]:r.children=t}return null!=e&&null!=(s=e.children)&&s.length||null!=r&&null!=(o=r.children)&&o.length?r:null})).filter((e=>e)):[],s=n(t);D(s||[])}else p.ZP.error(e.json.meta.message)}))}),[]),(0,v.tZ)("div",{"data-test":"DatabaseSelector"},(0,v.tZ)(_,{renderSelect:(0,v.tZ)("div",null,(0,v.tZ)("div",null,(0,r.t)("Select database or type database name")),(0,v.tZ)(f.Z,{allowClear:!0,showSearch:!0,style:{width:"100%"},value:j,dropdownStyle:{maxHeight:400,overflow:"auto"},placeholder:(0,r.t)("Select database or type database name"),filterTreeNode:()=>!0,treeDefaultExpandAll:!0,onChange:Q,treeData:F,onSearch:e=>U(e)}))}),function(){const e=!$&&(0,v.tZ)(h.Z,{onClick:()=>X(),tooltipContent:(0,r.t)("Force refresh schema list")});return(0,v.tZ)(_,{renderSelect:(0,v.tZ)(d.Ph,{ariaLabel:(0,r.t)("Select schema or type schema name"),disabled:!N||$,header:(0,v.tZ)(u.lX,null,(0,r.t)("Schema")),labelInValue:!0,loading:B,name:"select-schema",notFoundContent:(0,r.t)("No compatible schema found"),placeholder:(0,r.t)("Select schema or type schema name"),onChange:e=>P(e),options:K,showSearch:!0,value:I}),refreshBtn:e})}())}},940277:(e,t,a)=>{a.d(t,{Z:()=>r});var n=a(667294),l=a(358593),s=a(731293),o=a(211965);const r=({onClick:e,tooltipContent:t})=>{const a=(0,n.forwardRef)(((e,t)=>(0,o.tZ)(s.Z.Refresh,e)));return(0,o.tZ)(l.u,{title:t},(0,o.tZ)(a,{role:"button",onClick:e,css:e=>({cursor:"pointer",color:e.colors.grayscale.base,"&:hover":{color:e.colors.primary.base}})}))}},517982:(e,t,a)=>{a.d(t,{PH:()=>w,ZP:()=>x,ez:()=>_});var n=a(205872),l=a.n(n),s=a(667294),o=a(751995),r=a(455867),i=a(49937),d=a(49238),c=a(731293),u=a(73995),h=a(940277),m=a(679789),b=a(486057),p=a(414114),f=a(442582),v=a(998286),g=a(211965);const S=o.iK.div`
  ${({theme:e})=>`\n    > .section {\n      margin-top: ${4*e.gridUnit}px;\n    }\n\n    .divider {\n      border-bottom: 1px solid ${e.colors.secondary.light5};\n      margin: 15px 0;\n    }\n  `}
`,Z=o.iK.span`
  align-items: center;
  display: flex;
  flex: 1;

  svg,
  small {
    margin-right: ${({theme:e})=>e.gridUnit}px;
  }

  span.title {
    flex: 1;
    width: 0;
    overflow: hidden;
    white-space: nowrap;
    text-overflow: ellipsis;
  }
`,_=({table:e})=>{const{value:t,type:a,extra:n}=e;return(0,g.tZ)(Z,{title:t},"view"===a?(0,g.tZ)(c.Z.Eye,{iconSize:"m"}):(0,g.tZ)(c.Z.Table,{iconSize:"m"}),(null==n?void 0:n.certification)&&(0,g.tZ)(m.Z,{certifiedBy:n.certification.certified_by,details:n.certification.details,size:"l"}),(null==n?void 0:n.warning_markdown)&&(0,g.tZ)(b.Z,{warningMarkdown:n.warning_markdown,size:"l"}),(0,g.tZ)("span",{className:"title"},t))},y=({database:e,emptyState:t,formMode:a=!1,getDbList:n,handleError:l,isDatabaseSelectEnabled:o=!0,onDbChange:c,onSchemaChange:m,onSchemasLoad:b,onTablesLoad:Z,readOnly:y=!1,onEmptyResults:w,schema:x,sqlLabMode:$=!0,tableSelectMode:C="single",tableValue:E,onTableSelectChange:N})=>{const{addSuccessToast:k}=(0,p.e1)(),[I,L]=(0,s.useState)(x),[j,M]=(0,s.useState)(void 0),{data:O,isFetching:D,isFetched:R,refetch:T}=(0,f.zA)({dbId:null==e?void 0:e.id,schema:I,onSuccess:()=>{R&&k((0,r.t)("List updated"))},onError:e=>{(0,v.O$)(e).then((e=>{l((0,v.d7)((0,r.t)("There was an error loading the tables"),e))}))}});(0,s.useEffect)((()=>{O&&R&&(null==Z||Z(O.options))}),[O,R,Z]);const U=(0,s.useMemo)((()=>O?O.options.map((e=>({value:e.value,label:(0,g.tZ)(_,{table:e}),text:e.value}))):[]),[O]);(0,s.useEffect)((()=>{void 0===e&&(L(void 0),M(void 0))}),[e,C]),(0,s.useEffect)((()=>{M("single"===C?U.find((e=>e.value===E)):(null==U?void 0:U.filter((e=>e&&(null==E?void 0:E.includes(e.value)))))||[])}),[U,E,C]);const J=e=>{I?null==N||N(Array.isArray(e)?e.map((e=>null==e?void 0:e.value)):null==e?void 0:e.value,I):M(e)},z=(0,s.useMemo)((()=>(e,t)=>{const a=e.trim().toLowerCase(),{text:n}=t;return n.toLowerCase().includes(a)}),[]);return(0,g.tZ)(S,{"data-test":"table-selector"},(0,g.tZ)(u.ZP,{db:e,emptyState:t,formMode:a,getDbList:n,handleError:l,onDbChange:y?void 0:e=>{c&&c(e)},onEmptyResults:w,onSchemaChange:y?void 0:e=>{L(e),m&&m(e);J("single"===C?void 0:[])},onSchemasLoad:b,schema:I,sqlLabMode:$,isDatabaseSelectEnabled:o&&!y,readOnly:y}),$&&!a&&(0,g.tZ)("div",{className:"divider"}),function(){const e=I&&!a&&y||!I,t=$?(0,g.tZ)(d.lX,null,(0,r.t)("See table schema")):(0,g.tZ)(d.lX,null,(0,r.t)("Table")),n=(0,g.tZ)(i.Ph,{ariaLabel:(0,r.t)("Select table or type table name"),disabled:e,filterOption:z,header:t,labelInValue:!0,loading:D,name:"select-table",onChange:e=>J(e),options:U,placeholder:(0,r.t)("Select table or type table name"),showSearch:!0,mode:C,value:j,allowClear:"multiple"===C}),l=!y&&(0,g.tZ)(h.Z,{onClick:()=>T(),tooltipContent:(0,r.t)("Force refresh table list")});return(0,g.tZ)(u.Mh,{renderSelect:n,refreshBtn:l})}())},w=e=>(0,g.tZ)(y,l()({tableSelectMode:"multiple"},e)),x=y},442582:(e,t,a)=>{a.d(t,{s_:()=>n.s_,hb:()=>i,QU:()=>d,Es:()=>c,JL:()=>u,Xx:()=>p,zA:()=>f});var n=a(242190),l=a(115926),s=a.n(l);function o({owners:e}){return e?e.map((e=>`${e.first_name} ${e.last_name}`)):null}const r=s().encode({columns:["owners.first_name","owners.last_name"],keys:["none"]});function i(e){return(0,n.l6)((0,n.s_)(`/api/v1/chart/${e}?q=${r}`),o)}const d=e=>(0,n.l6)((0,n.s_)(`/api/v1/dashboard/${e}`),(e=>({...e,metadata:e.json_metadata&&JSON.parse(e.json_metadata)||{},position_data:e.position_json&&JSON.parse(e.position_json),mobile_metadata:e.mobile_json_metadata&&JSON.parse(e.mobile_json_metadata)||{},mobile_position_data:e.mobile_position_json&&JSON.parse(e.mobile_position_json)||e.mobile_json_metadata&&JSON.parse(e.mobile_json_metadata).positions||{}}))),c=e=>(0,n.s_)(`/api/v1/dashboard/${e}/charts`),u=e=>(0,n.s_)(`/api/v1/dashboard/${e}/datasets`);var h=a(667294),m=a(388767),b=a(431069);function p(e){const{dbId:t,onSuccess:a,onError:n}=e||{},l=(0,h.useRef)(!1),o={dbId:t},r=(0,m.useQuery)(["schemas",{dbId:t}],(()=>function({dbId:e,forceRefresh:t}){const a=`/api/v1/database/${e}/schemas/?q=${s().encode({force:t})}`;return b.Z.get({endpoint:a})}({...o,forceRefresh:l.current})),{select:({json:e})=>e.result.map((e=>({value:e,label:e,title:e}))),enabled:Boolean(t),onSuccess:a,onError:n,onSettled:()=>{l.current=!1}});return{...r,refetch:()=>(l.current=!0,r.refetch())}}function f(e){const{data:t,isFetching:a}=p({dbId:e.dbId}),n=(0,h.useMemo)((()=>new Set(null==t?void 0:t.map((({value:e})=>e)))),[t]),{dbId:l,schema:o,onSuccess:r,onError:i}=e||{},d=(0,h.useRef)(!1),c={dbId:l,schema:o},u=(0,m.useQuery)(["tables",{dbId:l,schema:o}],(()=>function({dbId:e,schema:t,forceRefresh:a}){const n=t?encodeURIComponent(t):"",l=`/api/v2/database/${null!=e?e:"undefined"}/tables/?q=${s().encode({force:a,schema_name:n})}`;return b.Z.get({endpoint:l})}({...c,forceRefresh:d.current})),{select:({json:e})=>({options:e.result,hasMore:e.count>e.result.length}),enabled:Boolean(l&&o&&!a&&n.has(o)),onSuccess:r,onError:i,onSettled:()=>{d.current=!1}});return{...u,refetch:()=>(d.current=!0,u.refetch())}}}}]);